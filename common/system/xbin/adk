#!/system/bin/sh
# App Data Keeper (adk) wizard
# Copyright (C) 2018, VR25 @ xda-developers
# License: GPL v3+


# shell behavior
set -o errexit # set -e
set -o nounset # set -u
set -o pipefail
#set -o xtrace # set -x
#IFS=$'\n\t' # new line & tab
umask 000 # default perms (d=rwx-rwx-rwx, f=rw-rw-rw)

modId=adk
modData=/data/media/$modId
Config=$modData/config.txt
logsDir=$modData/logs
logFile=$logsDir/wizard.log
oldLog=$logFile.old

# prepend Magisk's busybox to PATH
PATH=/sbin/.core/busybox:$PATH

# log engine
mkdir -p $logsDir
[ -f "$logFile" ] && mv $logFile $oldLog
set +u
[ -n "$EPOCHREALTIME" ] && PS4='[$EPOCHREALTIME] '
set -u
set -o xtrace 2>>$logFile # set -x

# exit trap (debugging tool)
debug_exit() {
  echo -e "\n***EXIT $?***\n"
  set +euxo pipefail
  getprop | grep -Ei 'product|version'
  echo
  set
  echo
  echo "SELinux status: $(getenforce 2>/dev/null || sestatus 2>/dev/null)" \
    | sed 's/En/en/;s/Pe/pe/'
} &>>$logFile
trap debug_exit EXIT

# find modPath
modPath=$(sed -n 's/^.*MOUNTPATH=//p' /data/adb/magisk/util_functions.sh)/$modId
[ -f $modPath/module.prop ] || { echo -e "\n(!) modPath not found\n"; exit 1; }

source $modPath/core.sh # load core
wizard
